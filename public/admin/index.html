<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager - Dhimahi Technolabs</title>
  
  <!-- Security headers -->
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <!-- Tailwind CSS for preview styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
            'primary-dark': '#1d4ed8',
            accent: '#3b82f6',
            'accent-soft': '#dbeafe'
          }
        }
      }
    }
  </script>
  
  <style>
    /* Authentication styles */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .auth-card {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    
    .auth-logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      background: #667eea;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
    }
    
    .auth-title {
      margin: 0 0 0.5rem;
      color: #1a202c;
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .auth-subtitle {
      margin: 0 0 2rem;
      color: #718096;
      font-size: 0.875rem;
    }
    
    .auth-button {
      background: #667eea;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 100%;
    }
    
    .auth-button:hover:not(:disabled) {
      background: #5a67d8;
    }
    
    .auth-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: #fed7d7;
      color: #c53030;
      padding: 0.75rem;
      border-radius: 6px;
      margin: 1rem 0;
      font-size: 0.875rem;
    }
    
    .success-message {
      background: #c6f6d5;
      color: #2f855a;
      padding: 0.75rem;
      border-radius: 6px;
      margin: 1rem 0;
      font-size: 0.875rem;
    }

    /* CMS preview styles */
    .cms-preview {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
    }
    
    .cms-preview h1, .cms-preview h2, .cms-preview h3, .cms-preview h4 {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .cms-preview .prose {
      max-width: none;
    }
    
    .cms-preview .prose h2 {
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.5rem;
    }
    
    .cms-preview .prose blockquote {
      border-left: 4px solid #3b82f6;
      padding-left: 1rem;
      font-style: italic;
      color: #6b7280;
    }
    
    .cms-preview .prose code {
      background-color: #f3f4f6;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
    }
    
    .cms-preview .prose pre {
      background-color: #1f2937;
      color: white;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
    }

    /* Enhanced media management styles */
    .media-widget {
      margin-bottom: 16px;
    }
    
    .media-preview img {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-radius: 4px;
    }
    
    .media-browser {
      max-height: 80vh;
      overflow-y: auto;
    }
    
    /* Improved form styling */
    .cms-editor-visual .public-DraftEditor-content {
      min-height: 200px;
    }
    
    /* Better media field styling */
    .cms-field-wrapper {
      margin-bottom: 24px;
    }
    
    .cms-field-wrapper label {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
      display: block;
    }
    
    /* Upload progress styling */
    .upload-progress {
      background: #e2e8f0;
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .upload-progress-bar {
      background: linear-gradient(90deg, #4299e1, #3182ce);
      height: 100%;
      transition: width 0.3s ease;
    }

    /* Image gallery preview styles */
    .image-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 16px 0;
    }
    
    .image-gallery figure {
      margin: 0;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .image-gallery img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
    
    .image-gallery figcaption {
      padding: 8px;
      font-size: 14px;
      color: #6b7280;
      background: #f9fafb;
    }

    /* Before/after component styles */
    .before-after {
      margin: 24px 0;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .before-after-images {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }
    
    .before-after .before,
    .before-after .after {
      position: relative;
    }
    
    .before-after img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    
    .before-after .label {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .before-after .caption {
      padding: 12px;
      margin: 0;
      background: #f9fafb;
      font-size: 14px;
      color: #6b7280;
    }

    /* Accessibility indicators */
    .accessibility-warning {
      background: #fef3cd;
      border: 1px solid #fbbf24;
      border-radius: 4px;
      padding: 8px 12px;
      margin: 8px 0;
      font-size: 14px;
      color: #92400e;
    }
    
    .accessibility-success {
      background: #d1fae5;
      border: 1px solid #10b981;
      border-radius: 4px;
      padding: 8px 12px;
      margin: 8px 0;
      font-size: 14px;
      color: #065f46;
    }

    /* User role indicator */
    .user-role-badge {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4f46e5;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      z-index: 1000;
      text-transform: uppercase;
    }

    .user-role-badge.admin {
      background: #dc2626;
    }

    .user-role-badge.editor {
      background: #059669;
    }

    .user-role-badge.contributor {
      background: #7c3aed;
    }
  </style>
</head>
<body>
  <!-- Authentication container (shown when not authenticated) -->
  <div id="auth-container" class="auth-container" style="display: none;">
    <div class="auth-card">
      <div class="auth-logo">DT</div>
      <h1 class="auth-title">Content Manager</h1>
      <p class="auth-subtitle">Sign in to manage website content</p>
      <div id="auth-messages"></div>
      <button id="auth-button" class="auth-button" onclick="handleLogin()">
        Sign In with Netlify Identity
      </button>
      <div style="margin-top: 1rem; font-size: 0.75rem; color: #718096;">
        Access is by invitation only. Contact an administrator if you need access.
      </div>
    </div>
  </div>

  <!-- CMS container (shown when authenticated) -->
  <div id="cms-container" style="display: none;">
    <!-- User role indicator -->
    <div id="user-role-badge" class="user-role-badge" style="display: none;"></div>

    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <!-- Custom media widget -->
    <script src="/admin/media-widget.js"></script>
    
    <!-- Load preview templates -->
    <script src="/admin/preview-templates/homepage-preview.js"></script>
    <script src="/admin/preview-templates/service-preview.js"></script>
    <script src="/admin/preview-templates/case-study-preview.js"></script>
    <script src="/admin/preview-templates/insight-preview.js"></script>
    <script src="/admin/preview-templates/pages-preview.js"></script>
    <script src="/admin/preview-templates/settings-preview.js"></script>
  </div>

  <!-- Authentication and initialization script -->
  <script>
    // Authentication state management
    let isAuthenticated = false;
    let currentUser = null;
    let authAttempts = 0;
    const maxAuthAttempts = 5;

    // Initialize Netlify Identity
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on('init', user => {
        console.log('Netlify Identity initialized');
        if (user) {
          handleAuthSuccess(user);
        } else {
          showAuthContainer();
        }
      });

      window.netlifyIdentity.on('login', user => {
        console.log('User logged in:', user.email);
        handleAuthSuccess(user);
        resetAuthAttempts();
      });

      window.netlifyIdentity.on('logout', () => {
        console.log('User logged out');
        handleLogout();
      });

      window.netlifyIdentity.on('error', err => {
        console.error('Netlify Identity error:', err);
        handleAuthError(err);
      });

      // Initialize the widget
      window.netlifyIdentity.init({
        APIUrl: 'https://dhimahi-preview-site.netlify.app/.netlify/identity'
      });
    }

    // Handle successful authentication
    function handleAuthSuccess(user) {
      isAuthenticated = true;
      currentUser = user;
      
      // Determine user role
      const userRole = user.app_metadata?.roles?.[0] || 'editor';
      
      // Store user data securely
      if (typeof Storage !== 'undefined') {
        sessionStorage.setItem('cms_user', JSON.stringify({
          id: user.id,
          email: user.email,
          name: user.user_metadata?.full_name || user.email,
          role: userRole,
          avatar_url: user.user_metadata?.avatar_url,
          created_at: user.created_at,
          updated_at: user.updated_at
        }));
      }

      // Show user role badge
      showUserRoleBadge(userRole);

      // Show CMS interface
      showCMSContainer();
      
      // Log security event
      logSecurityEvent('login', {
        userId: user.id,
        userEmail: user.email,
        userRole: userRole
      });
    }

    // Handle logout
    function handleLogout() {
      isAuthenticated = false;
      currentUser = null;
      
      // Clear stored data
      if (typeof Storage !== 'undefined') {
        sessionStorage.removeItem('cms_user');
        sessionStorage.removeItem('cms_auth_token');
      }
      
      // Hide user role badge
      hideUserRoleBadge();
      
      // Show auth container
      showAuthContainer();
      
      // Log security event
      logSecurityEvent('logout');
    }

    // Handle authentication errors
    function handleAuthError(error) {
      authAttempts++;
      
      let errorMessage = 'Authentication failed. Please try again.';
      
      if (error.message) {
        if (error.message.includes('Invalid credentials')) {
          errorMessage = 'Invalid email or password.';
        } else if (error.message.includes('User not found')) {
          errorMessage = 'User not found. Please contact an administrator for access.';
        } else if (error.message.includes('Email not confirmed')) {
          errorMessage = 'Please check your email and confirm your account.';
        } else if (error.message.includes('signup_disabled')) {
          errorMessage = 'Registration is disabled. Access is by invitation only.';
        }
      }
      
      if (authAttempts >= maxAuthAttempts) {
        errorMessage = 'Too many failed attempts. Please wait 15 minutes before trying again.';
        disableAuthButton(15 * 60 * 1000); // 15 minutes
      }
      
      showMessage(errorMessage, 'error');
      
      // Log security event
      logSecurityEvent('failed_login', {
        error: error.message,
        attempts: authAttempts
      });
    }

    // Handle login button click
    function handleLogin() {
      if (authAttempts >= maxAuthAttempts) {
        showMessage('Too many failed attempts. Please wait before trying again.', 'error');
        return;
      }

      const button = document.getElementById('auth-button');
      button.innerHTML = '<span class="loading-spinner"></span> Signing in...';
      button.disabled = true;
      
      try {
        window.netlifyIdentity.open();
      } catch (error) {
        console.error('Failed to open auth modal:', error);
        showMessage('Failed to open authentication. Please refresh and try again.', 'error');
        resetAuthButton();
      }
      
      // Reset button after timeout
      setTimeout(resetAuthButton, 10000);
    }

    // Reset authentication attempts
    function resetAuthAttempts() {
      authAttempts = 0;
    }

    // Reset auth button
    function resetAuthButton() {
      const button = document.getElementById('auth-button');
      button.innerHTML = 'Sign In with Netlify Identity';
      button.disabled = false;
    }

    // Disable auth button for specified duration
    function disableAuthButton(duration) {
      const button = document.getElementById('auth-button');
      button.disabled = true;
      
      const endTime = Date.now() + duration;
      
      const updateButton = () => {
        const remaining = Math.ceil((endTime - Date.now()) / 1000);
        if (remaining > 0) {
          button.innerHTML = `Try again in ${remaining}s`;
          setTimeout(updateButton, 1000);
        } else {
          resetAuthButton();
        }
      };
      
      updateButton();
    }

    // Show user role badge
    function showUserRoleBadge(role) {
      const badge = document.getElementById('user-role-badge');
      badge.textContent = role;
      badge.className = `user-role-badge ${role}`;
      badge.style.display = 'block';
    }

    // Hide user role badge
    function hideUserRoleBadge() {
      const badge = document.getElementById('user-role-badge');
      badge.style.display = 'none';
    }

    // Show authentication container
    function showAuthContainer() {
      document.getElementById('auth-container').style.display = 'flex';
      document.getElementById('cms-container').style.display = 'none';
    }

    // Show CMS container
    function showCMSContainer() {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('cms-container').style.display = 'block';
    }

    // Show message to user
    function showMessage(message, type = 'info') {
      const messagesContainer = document.getElementById('auth-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.textContent = message;
      
      messagesContainer.innerHTML = '';
      messagesContainer.appendChild(messageDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 5000);
    }

    // Log security events
    function logSecurityEvent(type, details = {}) {
      const event = {
        type,
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        ...details
      };
      
      console.log('Security Event:', event);
      
      // Store in session for audit trail
      if (typeof Storage !== 'undefined') {
        const events = JSON.parse(sessionStorage.getItem('security_events') || '[]');
        events.push(event);
        // Keep only last 50 events
        if (events.length > 50) {
          events.splice(0, events.length - 50);
        }
        sessionStorage.setItem('security_events', JSON.stringify(events));
      }
    }

    // Check for existing session on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Check if user is already authenticated
      if (typeof Storage !== 'undefined') {
        const userData = sessionStorage.getItem('cms_user');
        if (userData && window.netlifyIdentity?.currentUser()) {
          const user = JSON.parse(userData);
          handleAuthSuccess(window.netlifyIdentity.currentUser());
          return;
        }
      }
      
      // Show auth container if not authenticated
      showAuthContainer();
    });

    // Handle page visibility changes (security measure)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // Page is hidden - could implement additional security measures
        logSecurityEvent('page_hidden');
      } else {
        // Page is visible - verify authentication is still valid
        if (isAuthenticated && !window.netlifyIdentity?.currentUser()) {
          console.warn('Authentication state mismatch detected');
          handleLogout();
        }
      }
    });

    // Handle beforeunload for cleanup
    window.addEventListener('beforeunload', () => {
      if (isAuthenticated) {
        logSecurityEvent('page_unload');
      }
    });

    // Enhanced CMS initialization
    document.addEventListener('DOMContentLoaded', function() {
      // Register custom editor components for rich media
      if (typeof CMS !== 'undefined') {
        // Image gallery component
        CMS.registerEditorComponent({
          id: 'image-gallery',
          label: 'Image Gallery',
          fields: [
            {
              name: 'images',
              label: 'Images',
              widget: 'list',
              fields: [
                { name: 'src', label: 'Image', widget: 'image' },
                { name: 'alt', label: 'Alt Text', widget: 'string', required: true },
                { name: 'caption', label: 'Caption', widget: 'string', required: false }
              ]
            }
          ],
          pattern: /^<ImageGallery images=\{(.*?)\} \/>$/,
          fromBlock: function(match) {
            return {
              images: JSON.parse(match[1])
            };
          },
          toBlock: function(obj) {
            return `<ImageGallery images={${JSON.stringify(obj.images)}} />`;
          },
          toPreview: function(obj) {
            const images = obj.images || [];
            return `
              <div class="image-gallery">
                ${images.map(img => `
                  <figure>
                    <img src="${img.src}" alt="${img.alt}" />
                    ${img.caption ? `<figcaption>${img.caption}</figcaption>` : ''}
                  </figure>
                `).join('')}
              </div>
            `;
          }
        });

        // Before/after image component
        CMS.registerEditorComponent({
          id: 'before-after',
          label: 'Before/After Images',
          fields: [
            { name: 'before', label: 'Before Image', widget: 'image' },
            { name: 'beforeAlt', label: 'Before Alt Text', widget: 'string', required: true },
            { name: 'after', label: 'After Image', widget: 'image' },
            { name: 'afterAlt', label: 'After Alt Text', widget: 'string', required: true },
            { name: 'caption', label: 'Caption', widget: 'string', required: false }
          ],
          pattern: /^<BeforeAfter before="(.*?)" beforeAlt="(.*?)" after="(.*?)" afterAlt="(.*?)"(?: caption="(.*?)")? \/>$/,
          fromBlock: function(match) {
            return {
              before: match[1],
              beforeAlt: match[2],
              after: match[3],
              afterAlt: match[4],
              caption: match[5] || ''
            };
          },
          toBlock: function(obj) {
            const caption = obj.caption ? ` caption="${obj.caption}"` : '';
            return `<BeforeAfter before="${obj.before}" beforeAlt="${obj.beforeAlt}" after="${obj.after}" afterAlt="${obj.afterAlt}"${caption} />`;
          },
          toPreview: function(obj) {
            return `
              <div class="before-after">
                <div class="before-after-images">
                  <div class="before">
                    <img src="${obj.before}" alt="${obj.beforeAlt}" />
                    <span class="label">Before</span>
                  </div>
                  <div class="after">
                    <img src="${obj.after}" alt="${obj.afterAlt}" />
                    <span class="label">After</span>
                  </div>
                </div>
                ${obj.caption ? `<p class="caption">${obj.caption}</p>` : ''}
              </div>
            `;
          }
        });

        // Custom validation for accessibility
        CMS.registerEventListener({
          name: 'preSave',
          handler: ({ entry }) => {
            const data = entry.get('data');
            const errors = [];
            const warnings = [];

            // Check for images without alt text
            function checkAccessibility(obj, path = '') {
              if (typeof obj !== 'object' || obj === null) return;
              
              for (const [key, value] of Object.entries(obj)) {
                const currentPath = path ? `${path}.${key}` : key;
                
                if (key === 'src' && typeof value === 'string' && value.includes('/uploads/')) {
                  // This is an image field, check for alt text
                  const altValue = obj.alt;
                  
                  if (!altValue || altValue.trim() === '') {
                    errors.push(`Missing alt text for image at ${currentPath}`);
                  } else if (altValue.length < 10) {
                    warnings.push(`Alt text at ${currentPath} is very short (${altValue.length} characters). Consider adding more description.`);
                  }
                } else if (Array.isArray(value)) {
                  value.forEach((item, index) => {
                    checkAccessibility(item, `${currentPath}[${index}]`);
                  });
                } else if (typeof value === 'object') {
                  checkAccessibility(value, currentPath);
                }
              }
            }

            checkAccessibility(data.toJS());

            if (errors.length > 0) {
              throw new Error(`Accessibility issues found:\n${errors.join('\n')}\n\nAll images must have descriptive alt text for accessibility.`);
            }

            if (warnings.length > 0) {
              console.warn('Accessibility warnings:', warnings);
            }
          }
        });

        console.log('Enhanced CMS with authentication initialized');
      }
    });
  </script>
</body>
</html>